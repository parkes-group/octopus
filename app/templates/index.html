{% extends "base.html" %}

{% set page_name = 'index' %}

{% block head %}
<!-- Page-specific Structured Data (JSON-LD) -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@graph": [
        {
            "@type": "WebPage",
            "@id": "{{ site_url }}/#webpage",
            "url": "{{ site_url }}/",
            "name": "Save Money with Cheapest Octopus Agile Electricity Prices",
            "description": "Find the cheapest Agile Octopus electricity prices for your UK region. Discover optimal usage windows for appliances, home batteries and EVs to reduce electricity costs.",
            "inLanguage": "en-GB",
            "isPartOf": {
                "@type": "WebSite",
                "name": "{{ site_name }}",
                "url": "{{ site_url }}"
            },
            "about": {
                "@type": "Thing",
                "name": "Octopus Agile Tariff Electricity Pricing"
            }
        },
        {
            "@type": "SoftwareApplication",
            "name": "{{ site_name }}",
            "applicationCategory": "UtilityApplication",
            "operatingSystem": "Web",
            "description": "{{ site_description }}",
            "url": "{{ site_url }}",
            "areaServed": {
                "@type": "Country",
                "name": "United Kingdom"
            },
            "purpose": "Energy price optimisation for UK households on Octopus Agile tariff",
            "provider": {
                "@type": "Organization",
                "name": "Parkes Group Enterprise Ltd"
            },
            "offers": {
                "@type": "Offer",
                "price": "0",
                "priceCurrency": "GBP"
            },
            "featureList": [
                "Find cheapest times to use electricity",
                "Calculate cheapest continuous blocks",
                "Compare prices across UK regions",
                "Estimate charging costs",
                "View interactive price charts"
            ]
        },
        {
            "@type": "FAQPage",
            "mainEntity": [
                {
                    "@type": "Question",
                    "name": "How can I save money on Agile Octopus electricity?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Agile Octopus prices change every 30 minutes. By using energy during the cheapest time blocks each day, you can reduce electricity costs significantly. This tool helps you identify the cheapest usage windows for home batteries, EVs, and flexible appliances."
                    }
                },
                {
                    "@type": "Question",
                    "name": "What is the cheapest time to use electricity on Agile Octopus?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "The cheapest time varies daily and by region. Our tool analyses half-hourly prices from Octopus Energy's API to identify the cheapest 30-minute slot and cheapest continuous blocks (e.g., 3.5 hours) each day for your UK region."
                    }
                },
                {
                    "@type": "Question",
                    "name": "How does Agile Pricing help me find the cheapest electricity prices?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Enter your UK postcode to automatically detect your pricing region. We analyse official Octopus Energy data to show you the cheapest time blocks, compare them to daily averages, and estimate costs based on your usage. The tool is free to use and uses up-to-date 30 minute priceing from Octopus."
                    }
                },
                {
                    "@type": "Question",
                    "name": "Is Agile Pricing free to use?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Yes, Agile Pricing is completely free to use. Simply enter your UK postcode to see the cheapest electricity prices for your region. No registration or payment required."
                    }
                },
                {
                    "@type": "Question",
                    "name": "What is a cheapest remaining block?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "The cheapest remaining block is the cheapest continuous time period still available in the day (from now onwards). This helps you plan future energy use, such as charging batteries or EVs later in the day when prices are lowest."
                    }
                }
            ]
        }
    ]
}
</script>
{% endblock %}

{% block content %}
<article>
    <header>
        <h1 class="mb-3">Save Money with Cheapest Octopus Agile Electricity Prices</h1>
        
        {% if stats_2026 %}
            {% set avg_daily = stats_2026.daily_average_price %}
            {% set avg_cheapest = stats_2026.cheapest_block_price %}
            {% set cap = stats_2026.price_cap %}
            {% set pct_daily_vs_cheapest = ((avg_daily - avg_cheapest) / avg_daily * 100) if avg_daily else 0 %}
            {% set pct_cap_vs_cheapest = ((cap - avg_cheapest) / cap * 100) if cap else 0 %}
            {% set daily_kwh = stats_2026.assumptions.daily_kwh %}
            {% set cost_avg = (avg_daily * daily_kwh) / 100 %}
            {% set cost_cheapest = (avg_cheapest * daily_kwh) / 100 %}

        <p class="lead mb-3 text-muted">
            <small>
                So far in <strong>2026</strong>, Agile electricity prices have continued to vary throughout the day.
                Based on price data to date, the average Agile price is {{ "%.2f"|format(avg_daily) }}p/kWh, while the average cheapest 3.5h block is {{ "%.2f"|format(avg_cheapest) }}p/kWh
                (<strong>{{ "%.1f"|format(pct_daily_vs_cheapest) }}%</strong> cheaper; <strong>{{ "%.1f"|format(pct_cap_vs_cheapest) }}%</strong> below the price cap).
                Smart timing could mean paying about <strong>£{{ "%.2f"|format(cost_cheapest) }}</strong> instead of <strong>£{{ "%.2f"|format(cost_avg) }}</strong> for the same {{ "%.1f"|format(daily_kwh) }} kWh/day.
            </small>
        </p>
        {% else %}
        <!-- Savings Callout -->
        <div class="alert alert-secondary mb-3" role="alert">
            <p class="lead mb-0">
                <strong>Smart energy timing can significantly reduce electricity costs on Agile tariffs.</strong><br>
                <small class="text-muted">Octopus Agile pricing gives you the tools to make the savings.</small>
            </p>
        </div>

        {% endif %}
    </header>
    
    <section>
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                
                
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="card-title mb-0">Find your best usage times</h2>
                    </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">
                        {{ error }}
                    </div>
                {% endif %}
                
                <p class="text-muted">
                    Enter your UK postcode and we'll show you the <strong>cheapest electricity pricing blocks</strong> for your region. 
                </p>
                
                <!-- Combined Form -->
                <form method="POST" action="{{ url_for('main.index') }}" id="postcode-form">
                    {{ postcode_form.hidden_tag() }}
                    
                    <!-- 1. Postcode Entry -->
                    <div class="mb-3">
                        {{ postcode_form.postcode.label(class="form-label") }}
                        {% set postcode_class = "form-control" + (" is-invalid" if postcode_form.postcode.errors else "") %}
                        {% set aria_describedby = "postcode-help postcode-errors" if postcode_form.postcode.errors else "postcode-help" %}
                        {{ postcode_form.postcode(
                            class=postcode_class,
                            value=submitted_postcode if submitted_postcode else "",
                            **{"inputmode": "text", "autocomplete": "postal-code", "aria-describedby": aria_describedby}
                        ) }}
                        {% if postcode_form.postcode.errors %}
                            <div id="postcode-errors" class="invalid-feedback" role="alert">
                                {% for error in postcode_form.postcode.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small id="postcode-help" class="form-text text-muted">Enter your postcode - full or partial (e.g., SW1A 1AA or SW1)</small>
                    </div>
                    
                    <!-- 2. Region Selection (if applicable) -->
                    {% if show_region_dropdown %}
                    <div class="mb-3">
                        <label for="region" class="form-label">Region <span class="text-muted">(optional if entering new postcode)</span></label>
                        {% if error and 'matches multiple regions' in error %}
                            <p class="text-info mb-2" role="alert"><small><strong>{{ error }}</strong></small></p>
                        {% else %}
                            <small id="region-help" class="text-muted d-block mb-1">Select your region manually, or enter a different postcode above to try again</small>
                        {% endif %}
                        <select class="form-select" id="region" name="region" aria-describedby="region-help">
                            <option value="">Select a region (optional if entering new postcode)...</option>
                            {% for r in regions %}
                            <option value="{{ r.region }}" {% if request.form.get('region') == r.region %}selected{% endif %}>
                                {{ r.region }} - {{ r.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <!-- 3. Tariff Selection (if applicable) -->
                    {% if show_product_dropdown %}
                    <div class="mb-3">
                        <label for="product" class="form-label">Agile Tariff Version</label>
                        <small id="product-help" class="text-muted d-block mb-1">Select the Agile tariff version you want to view prices for</small>
                        <select class="form-select" id="product" name="product" required aria-describedby="product-help">
                            {% for p in agile_products %}
                            <option value="{{ p.code }}" {% if p.code == selected_product_code or request.form.get('product') == p.code %}selected{% endif %}>
                                {{ p.code }} — {{ p.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <input type="hidden" name="product" value="{{ selected_product_code }}">
                    {% if agile_products and selected_product_code %}
                        <!-- Single product: auto-selected, show info -->
                        <div class="mb-3">
                            <p class="mb-0 text-muted"><small><strong>Using tariff:</strong> <span class="text-primary">{{ selected_product_code }} — {{ selected_product_name }}</span></small></p>
                        </div>
                    {% endif %}
                    {% endif %}
                    
                    {{ postcode_form.submit(class="btn btn-primary w-100") }}
                </form>
            </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- How It Works Section -->
    <section class="my-5">
        <h2 class="mb-4">How Agile Pricing Works</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-size: 1.25rem; margin-right: 1rem;">1</span>
                            <h3 class="h5 mb-0">Enter Your Postcode</h3>
                        </div>
                        <p class="mb-0">
                            We automatically detect your Octopus Energy pricing region from your UK postcode. This ensures you see the most accurate half-hourly prices for your area.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-size: 1.25rem; margin-right: 1rem;">2</span>
                            <h3 class="h5 mb-0">We Analyse Half-Hourly Prices</h3>
                        </div>
                        <p class="mb-0">
                            Our tool processes official Octopus Energy data to identify the cheapest and most expensive time blocks each day, comparing them to daily averages and peak prices.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-size: 1.25rem; margin-right: 1rem;">3</span>
                            <h3 class="h5 mb-0">Use the Insight to Save Money</h3>
                        </div>
                        <p class="mb-0">
                            Plan battery charging, EV charging, and appliance use during the cheapest blocks. Avoid expensive peak periods to reduce your electricity costs significantly.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- 2026 YTD Statistics -->

    {% with stats=stats_2026, year=2026, show_note=false %}
        {% include 'components/_stats_2025.html' %}
    {% endwith %}
    {% with stats=stats_2025, year=2025, show_note=true %}
        {% include 'components/_stats_2025.html' %}
    {% endwith %}

    
    <!-- Internal Links to Other Pages -->
    <section class="my-5">
        <h2 class="mb-4">Explore More</h2>
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="h5 mb-3">View Today's Prices</h3>
                        <p class="mb-3">See the cheapest Agile Octopus electricity prices for your region with detailed analysis and interactive charts.</p>
                        <a href="{{ url_for('main.index') }}" class="btn btn-primary btn-sm">Find Your Prices</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="h5 mb-3">Compare Across Regions</h3>
                        <p class="mb-3">Compare Agile Octopus prices across all 14 UK regions to see regional variations in cheapest time blocks.</p>
                        <a href="{{ url_for('main.regions') }}" class="btn btn-outline-primary btn-sm">View Regional Comparison</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h3 class="h5 mb-3">Learn How It Works</h3>
                        <p class="mb-3">Understand how Agile Pricing works, where data comes from, and how to maximise your savings on the Agile tariff.</p>
                        <a href="{{ url_for('main.about') }}" class="btn btn-outline-primary btn-sm">Learn More</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Sticky CTA Bar (Bootstrap only, shows when main form is not visible) -->
    <div id="sticky-cta" class="fixed-top bg-primary shadow-sm border-bottom d-none">
        <div class="container py-2">
            <div class="row align-items-center g-2">
                <div class="col-12 col-md-auto">
                    <p class="mb-0 fw-bold small text-white">Find the cheapest Agile Octopus prices for your area</p>
                </div>
                <div class="col-12 col-md">
                    <form method="POST" action="{{ url_for('main.index') }}" class="d-flex gap-2">
                        {{ postcode_form.hidden_tag() }}
                        <input 
                            type="text" 
                            name="postcode" 
                            class="form-control form-control-sm" 
                            placeholder="Enter postcode (e.g., SW1A 1AA)" 
                            autocomplete="postal-code"
                            inputmode="text"
                            aria-label="Enter your UK postcode"
                            required
                        >
                        {% if show_product_dropdown and agile_products %}
                        <input type="hidden" name="product" value="{{ selected_product_code or agile_products[0]['code'] }}">
                        {% elif selected_product_code %}
                        <input type="hidden" name="product" value="{{ selected_product_code }}">
                        {% endif %}
                        <button type="submit" class="btn btn-primary btn-sm">Find Prices</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</article>
{% endblock %}
