{% extends "base.html" %}

{% set page_name = 'index' %}

{% block content %}
<article>
    <header>
        <h1 class="mb-4">Octopus Agile Pricing</h1>
    </header>
    
    <section>
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="card-title mb-0">Find your Region</h2>
                    </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">
                        {{ error }}
                    </div>
                {% endif %}
                
                <p class="text-muted">
                    Enter your UK postcode to automatically determine your Octopus Energy pricing region.
                    We use this to show you the <strong>cheapest electricity pricing blocks</strong> for your region, based on half-hourly Agile Octopus data.
                </p>
                
                <!-- Combined Form -->
                <form method="POST" action="{{ url_for('main.index') }}" id="main-form">
                    {{ postcode_form.hidden_tag() }}
                    
                    <!-- 1. Postcode Entry -->
                    <div class="mb-3">
                        {{ postcode_form.postcode.label(class="form-label") }}
                        {% set postcode_class = "form-control" + (" is-invalid" if postcode_form.postcode.errors else "") %}
                        {% set aria_describedby = "postcode-help postcode-errors" if postcode_form.postcode.errors else "postcode-help" %}
                        {{ postcode_form.postcode(
                            class=postcode_class,
                            value=submitted_postcode if submitted_postcode else "",
                            **{"inputmode": "text", "autocomplete": "postal-code", "aria-describedby": aria_describedby}
                        ) }}
                        {% if postcode_form.postcode.errors %}
                            <div id="postcode-errors" class="invalid-feedback" role="alert">
                                {% for error in postcode_form.postcode.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small id="postcode-help" class="form-text text-muted">Enter your postcode - full or partial (e.g., SW1A 1AA or SW1)</small>
                    </div>
                    
                    <!-- 2. Region Selection (if applicable) -->
                    {% if show_region_dropdown %}
                    <div class="mb-3">
                        <label for="region" class="form-label">Region <span class="text-muted">(optional if entering new postcode)</span></label>
                        {% if error and 'matches multiple regions' in error %}
                            <p class="text-info mb-2" role="alert"><small><strong>{{ error }}</strong></small></p>
                        {% else %}
                            <small id="region-help" class="text-muted d-block mb-1">Select your region manually, or enter a different postcode above to try again</small>
                        {% endif %}
                        <select class="form-select" id="region" name="region" aria-describedby="region-help">
                            <option value="">Select a region (optional if entering new postcode)...</option>
                            {% for r in regions %}
                            <option value="{{ r.region }}" {% if request.form.get('region') == r.region %}selected{% endif %}>
                                {{ r.region }} - {{ r.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <!-- 3. Tariff Selection (if applicable) -->
                    {% if show_product_dropdown %}
                    <div class="mb-3">
                        <label for="product" class="form-label">Agile Tariff Version</label>
                        <small id="product-help" class="text-muted d-block mb-1">Select the Agile tariff version you want to view prices for</small>
                        <select class="form-select" id="product" name="product" required aria-describedby="product-help">
                            {% for p in agile_products %}
                            <option value="{{ p.code }}" {% if p.code == selected_product_code or request.form.get('product') == p.code %}selected{% endif %}>
                                {{ p.code }} — {{ p.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <input type="hidden" name="product" value="{{ selected_product_code }}">
                    {% if agile_products and selected_product_code %}
                        <!-- Single product: auto-selected, show info -->
                        <div class="mb-3">
                            <p class="mb-0 text-muted"><small><strong>Using tariff:</strong> <span class="text-primary">{{ selected_product_code }} — {{ selected_product_name }}</span></small></p>
                        </div>
                    {% endif %}
                    {% endif %}
                    
                    {{ postcode_form.submit(class="btn btn-primary w-100") }}
                </form>
            </div>
                </div>
            </div>
        </div>
    </section>
    <br>
    <section>
        <p class="lead">
            Agile Pricing helps UK households save money on electricity by revealing the cheapest Agile Octopus prices every day.
Using official Octopus Energy half-hourly pricing data, we show you exactly when electricity is cheapest, so you can shift energy use, charge home batteries, or power EVs at the lowest possible cost.

By focusing your usage during the cheapest periods (and avoiding expensive peak times),  many households can significantly reduce their electricity bills, and in rare cases even get paid to use energy during negative pricing events.

Enter your postcode to see the cheapest Agile Octopus charging windows for your region today.
        </p>
    </section>

    <br>
    <!-- 2025 Statistics -->
    {% include 'components/_stats_2025.html' %}

</article>
{% endblock %}
