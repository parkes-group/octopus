{% extends "base.html" %}

{% set page_name = 'index' %}

{% block content %}
<article>
    <header>
        <h1 class="mb-3">Save Money with Cheapest Octopus Agile Electricity Prices</h1>
        <p class="lead mb-4 text-muted">
            <small>Discover the cheapest charging windows for your region and see how much you can save compared to daily average and peak prices. </small>
        </p>
        <!-- Savings Callout -->
        <div class="alert alert-secondary mb-3" role="alert">
            <p class="lead mb-0">
                <strong>Smart energy timing can significantly reduce electricity costs on Agile tariffs.</strong><br>
                <small class="text-muted">Octopus Agile pricing gives you the tools to make the savings.</small>
            </p>
        </div>
    </header>
    
    <section>
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                
                
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h2 class="card-title mb-0">Find your best usage times</h2>
                    </div>
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">
                        {{ error }}
                    </div>
                {% endif %}
                
                <p class="text-muted">
                    Enter your UK postcode and we'll show you the <strong>cheapest electricity pricing blocks</strong> for your region. 
                </p>
                
                <!-- Combined Form -->
                <form method="POST" action="{{ url_for('main.index') }}" id="postcode-form">
                    {{ postcode_form.hidden_tag() }}
                    
                    <!-- 1. Postcode Entry -->
                    <div class="mb-3">
                        {{ postcode_form.postcode.label(class="form-label") }}
                        {% set postcode_class = "form-control" + (" is-invalid" if postcode_form.postcode.errors else "") %}
                        {% set aria_describedby = "postcode-help postcode-errors" if postcode_form.postcode.errors else "postcode-help" %}
                        {{ postcode_form.postcode(
                            class=postcode_class,
                            value=submitted_postcode if submitted_postcode else "",
                            **{"inputmode": "text", "autocomplete": "postal-code", "aria-describedby": aria_describedby}
                        ) }}
                        {% if postcode_form.postcode.errors %}
                            <div id="postcode-errors" class="invalid-feedback" role="alert">
                                {% for error in postcode_form.postcode.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small id="postcode-help" class="form-text text-muted">Enter your postcode - full or partial (e.g., SW1A 1AA or SW1)</small>
                    </div>
                    
                    <!-- 2. Region Selection (if applicable) -->
                    {% if show_region_dropdown %}
                    <div class="mb-3">
                        <label for="region" class="form-label">Region <span class="text-muted">(optional if entering new postcode)</span></label>
                        {% if error and 'matches multiple regions' in error %}
                            <p class="text-info mb-2" role="alert"><small><strong>{{ error }}</strong></small></p>
                        {% else %}
                            <small id="region-help" class="text-muted d-block mb-1">Select your region manually, or enter a different postcode above to try again</small>
                        {% endif %}
                        <select class="form-select" id="region" name="region" aria-describedby="region-help">
                            <option value="">Select a region (optional if entering new postcode)...</option>
                            {% for r in regions %}
                            <option value="{{ r.region }}" {% if request.form.get('region') == r.region %}selected{% endif %}>
                                {{ r.region }} - {{ r.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <!-- 3. Tariff Selection (if applicable) -->
                    {% if show_product_dropdown %}
                    <div class="mb-3">
                        <label for="product" class="form-label">Agile Tariff Version</label>
                        <small id="product-help" class="text-muted d-block mb-1">Select the Agile tariff version you want to view prices for</small>
                        <select class="form-select" id="product" name="product" required aria-describedby="product-help">
                            {% for p in agile_products %}
                            <option value="{{ p.code }}" {% if p.code == selected_product_code or request.form.get('product') == p.code %}selected{% endif %}>
                                {{ p.code }} — {{ p.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <input type="hidden" name="product" value="{{ selected_product_code }}">
                    {% if agile_products and selected_product_code %}
                        <!-- Single product: auto-selected, show info -->
                        <div class="mb-3">
                            <p class="mb-0 text-muted"><small><strong>Using tariff:</strong> <span class="text-primary">{{ selected_product_code }} — {{ selected_product_name }}</span></small></p>
                        </div>
                    {% endif %}
                    {% endif %}
                    
                    {{ postcode_form.submit(class="btn btn-primary w-100") }}
                </form>
            </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- How It Works Section -->
    <section class="my-5">
        <h2 class="mb-4">How Agile Pricing Works</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-size: 1.25rem; margin-right: 1rem;">1</span>
                            <h3 class="h5 mb-0">Enter Your Postcode</h3>
                        </div>
                        <p class="mb-0">
                            We automatically detect your Octopus Energy pricing region from your UK postcode. This ensures you see the most accurate half-hourly prices for your area.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-size: 1.25rem; margin-right: 1rem;">2</span>
                            <h3 class="h5 mb-0">We Analyse Half-Hourly Prices</h3>
                        </div>
                        <p class="mb-0">
                            Our tool processes official Octopus Energy data to identify the cheapest and most expensive time blocks each day, comparing them to daily averages and peak prices.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="badge bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; font-size: 1.25rem; margin-right: 1rem;">3</span>
                            <h3 class="h5 mb-0">Use the Insight to Save Money</h3>
                        </div>
                        <p class="mb-0">
                            Plan battery charging, EV charging, and appliance use during the cheapest blocks. Avoid expensive peak periods to reduce your electricity costs significantly.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <br>
    <!-- 2025 Statistics -->
    {% include 'components/_stats_2025.html' %}

    <!-- Sticky CTA Bar (Bootstrap only, shows when main form is not visible) -->
    <div id="sticky-cta" class="fixed-top bg-white shadow-sm border-bottom d-none">
        <div class="container py-2">
            <div class="row align-items-center g-2">
                <div class="col-12 col-md-auto">
                    <p class="mb-0 fw-bold small">Find the cheapest Agile Octopus prices for your area</p>
                </div>
                <div class="col-12 col-md">
                    <form method="POST" action="{{ url_for('main.index') }}" class="d-flex gap-2">
                        {{ postcode_form.hidden_tag() }}
                        <input 
                            type="text" 
                            name="postcode" 
                            class="form-control form-control-sm" 
                            placeholder="Enter postcode (e.g., SW1A 1AA)" 
                            autocomplete="postal-code"
                            inputmode="text"
                            aria-label="Enter your UK postcode"
                            required
                        >
                        {% if show_product_dropdown and agile_products %}
                        <input type="hidden" name="product" value="{{ selected_product_code or agile_products[0]['code'] }}">
                        {% elif selected_product_code %}
                        <input type="hidden" name="product" value="{{ selected_product_code }}">
                        {% endif %}
                        <button type="submit" class="btn btn-primary btn-sm">Find Prices</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</article>
{% endblock %}
