{% extends "base.html" %}

{% set page_name = 'prices' %}

{% block content %}
<article>
    <header>
        <h1 class="mb-4">Agile Octopus Prices</h1>
    </header>
    
    <section>
        <div class="row">
            <div class="col-12">
        
        <!-- Product Info -->
        {% if product_code and product_name %}
        <div class="alert alert-info mb-3">
            <strong>Using tariff:</strong> {{ product_code }} ‚Äî {{ product_name }}
        </div>
        {% endif %}
        
        <!-- Region and Controls -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('main.prices') }}" class="row g-3">
                    {% if agile_products and agile_products|length > 1 %}
                    <div class="col-md-3">
                        <label for="product" class="form-label">Agile Tariff Version</label>
                        <select class="form-select" id="product" name="product" required>
                            {% for p in agile_products %}
                            <option value="{{ p.code }}" {% if p.code == product_code %}selected{% endif %}>
                                {{ p.code }} ‚Äî {{ p.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <input type="hidden" name="product" value="{{ product_code }}">
                    {% endif %}
                    
                    <div class="col-md-3">
                        <label for="region" class="form-label">Region</label>
                        <select class="form-select" id="region" name="region" required>
                            {% for r in regions %}
                            <option value="{{ r.region }}" {% if r.region == region %}selected{% endif %}>
                                {{ r.region }} - {{ r.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="duration" class="form-label">Charging Duration (hours)</label>
                        <input type="number" 
                               class="form-control" 
                               id="duration" 
                               name="duration" 
                               value="{{ duration }}" 
                               step="0.5" 
                               min="0.5" 
                               max="6.0" 
                               required>
                        <small class="text-muted">Supports decimals (e.g., 3.5)</small>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="capacity" class="form-label">Battery Capacity (kWh) <span class="text-muted">(optional)</span></label>
                        <input type="number" 
                               class="form-control" 
                               id="capacity" 
                               name="capacity" 
                               value="{{ capacity if capacity else '' }}" 
                               step="0.1" 
                               min="0.1" 
                               placeholder="e.g., 10.0">
                    </div>
                    
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Update</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Daily Average Price -->
        {% if daily_average_price %}
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card border-secondary">
                    <div class="card-body">
                        <p class="mb-0">
                            <strong>Daily Average Price:</strong> 
                            <span class="h4 text-secondary">{{ "%.2f"|format(daily_average_price) }} p/kWh</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Results -->
        <div class="row">
            <!-- Lowest Price -->
            {% if lowest_price %}
            <div class="col-md-4 mb-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üí∞ Lowest 30-Minute Price</h5>
                    </div>
                    <div class="card-body">
                        <h3 class="text-success">{{ "%.2f"|format(lowest_price.price) }} p/kWh</h3>
                        <p class="mb-0">
                            <strong>Time:</strong> 
                            {{ lowest_price.time_from_uk.strftime('%d/%m %H:%M') }} - 
                            {{ lowest_price.time_to_uk.strftime('%H:%M') }}
                        </p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Absolute Cheapest Block -->
            {% if absolute_cheapest_block %}
            <div class="col-md-4 mb-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">‚ö° Absolute Cheapest {{ duration }}h Block</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1">
                            <strong>Average price:</strong> 
                            <span class="h4 text-warning">{{ "%.2f"|format(absolute_cheapest_block.average_price) }} p/kWh</span>
                        </p>
                        {% if daily_average_price and absolute_cheapest_block.average_price < daily_average_price %}
                        {% set abs_savings_pkwh = daily_average_price - absolute_cheapest_block.average_price %}
                        <p class="mb-1">
                            <small class="text-success">
                                <strong>Savings:</strong> {{ "%.2f"|format(abs_savings_pkwh) }} p/kWh vs daily average
                                {% if capacity %}
                                    {% set abs_total_savings = (abs_savings_pkwh * capacity) / 100 %}
                                    ({{ "%.2f"|format(abs_savings_pkwh) }} p/kWh √ó {{ capacity }} kWh = <strong>¬£{{ "%.2f"|format(abs_total_savings) }}</strong>)
                                {% endif %}
                            </small>
                        </p>
                        {% endif %}
                        <p class="mb-1">
                            <strong>Time:</strong> 
                            {{ absolute_cheapest_block.start_time_uk.strftime('%d/%m %H:%M') }} - 
                            {{ absolute_cheapest_block.end_time_uk.strftime('%H:%M') }}
                        </p>
                        {% set abs_block_end_uk = absolute_cheapest_block.end_time_uk %}
                        {% if abs_block_end_uk < current_time_uk %}
                        <p class="mb-0"><small class="text-muted">‚è±Ô∏è Already passed</small></p>
                        {% else %}
                        <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Future Cheapest Block -->
            {% if future_cheapest_block %}
            <div class="col-md-4 mb-4">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üîÆ Cheapest Remaining {{ duration }}h Block</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1">
                            <strong>Average price:</strong> 
                            <span class="h4 text-info">{{ "%.2f"|format(future_cheapest_block.average_price) }} p/kWh</span>
                        </p>
                        {% if daily_average_price and future_cheapest_block.average_price < daily_average_price %}
                        {% set future_savings_pkwh = daily_average_price - future_cheapest_block.average_price %}
                        <p class="mb-1">
                            <small class="text-success">
                                <strong>Savings:</strong> {{ "%.2f"|format(future_savings_pkwh) }} p/kWh vs daily average
                                {% if capacity %}
                                    {% set future_total_savings = (future_savings_pkwh * capacity) / 100 %}
                                    ({{ "%.2f"|format(future_savings_pkwh) }} p/kWh √ó {{ capacity }} kWh = <strong>¬£{{ "%.2f"|format(future_total_savings) }}</strong>)
                                {% endif %}
                            </small>
                        </p>
                        {% endif %}
                        <p class="mb-1">
                            <strong>Time:</strong> 
                            {{ future_cheapest_block.start_time_uk.strftime('%d/%m %H:%M') }} - 
                            {{ future_cheapest_block.end_time_uk.strftime('%H:%M') }}
                        </p>
                        {% if estimated_cost %}
                        <p class="mb-1">
                            <strong>Estimated Cost:</strong> 
                            <span class="h5 text-info">¬£{{ "%.2f"|format(estimated_cost) }}</span>
                        </p>
                        {% endif %}
                        <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                    </div>
                </div>
            </div>
            {% elif duration and duration > 0 %}
            <div class="col-md-4 mb-4">
                <div class="card border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">üîÆ Cheapest Remaining Block</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-0 text-muted">No remaining cheap blocks today</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Price Chart -->
        {% if chart_data %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Price Chart</h5>
                <small class="text-muted">
                    {% if absolute_cheapest_block and future_cheapest_block %}
                        Highlighted: Absolute cheapest block (green), Cheapest remaining block (blue)
                    {% elif absolute_cheapest_block %}
                        Highlighted: Absolute cheapest block (green)
                    {% elif future_cheapest_block %}
                        Highlighted: Cheapest remaining block (blue)
                    {% elif lowest_price %}
                        Highlighted: Lowest 30-minute price (green)
                    {% endif %}
                </small>
            </div>
            <div class="card-body">
                <canvas id="priceChart" height="100"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Price Table -->
        {% if prices %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Prices (Half-Hourly)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Price (p/kWh)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in prices %}
                            {% set is_lowest = lowest_price and price.value_inc_vat == lowest_price.price and price.valid_from == lowest_price.time_from %}
                            {% set is_in_absolute_block = price.valid_from in absolute_cheapest_block_times %}
                            {% set is_in_future_block = price.valid_from in future_cheapest_block_times %}
                            {% if loop.first %}
                                {% set show_date = True %}
                            {% else %}
                                {% set prev_price = prices[loop.index0 - 1] %}
                                {% set prev_date = prev_price.date_uk %}
                                {% set show_date = price.date_uk != prev_date %}
                            {% endif %}
                            <tr {% if is_in_future_block %}class="table-info"{% elif is_in_absolute_block %}class="table-warning"{% elif is_lowest %}class="table-success"{% endif %}>
                                <td>
                                    {% if show_date %}
                                        <strong>{{ price.date_uk }}</strong><br>
                                    {% endif %}
                                    {{ price.time_uk }}
                                </td>
                                <td>
                                    {{ "%.2f"|format(price.value_inc_vat) }}
                                    {% if is_lowest %}<span class="badge bg-success ms-2">Lowest</span>{% endif %}
                                    {% if is_in_future_block %}<span class="badge bg-info ms-2">Cheapest Remaining</span>{% endif %}
                                    {% if is_in_absolute_block %}<span class="badge bg-warning text-dark ms-2">Absolute Cheapest</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
            </div>
        </div>
    </section>
</article>
{% endblock %}

{% block scripts %}
<script>
    // Render price chart with highlighting
    {% if chart_data %}
    const chartData = {{ chart_data | tojson }};
    const absoluteCheapestBlockIndices = chartData.absolute_cheapest_block_indices || [];
    const futureCheapestBlockIndices = chartData.future_cheapest_block_indices || [];
    const lowestPriceIndex = chartData.lowest_price_index;
    const hasDuration = {{ duration|default(0)|float }} > 0;
    
    const ctx = document.getElementById('priceChart');
    if (ctx && chartData.labels && chartData.prices) {
        // Create a set of all indices that need highlighting (future block takes priority)
        const allHighlightedIndices = new Set([
            ...absoluteCheapestBlockIndices,
            ...futureCheapestBlockIndices
        ]);
        
        // Create datasets - main line and highlighted points
        const datasets = [{
            label: 'Price (p/kWh)',
            data: chartData.prices,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            pointRadius: chartData.prices.map((price, index) => {
                return allHighlightedIndices.has(index) || index === lowestPriceIndex ? 0 : 3;
            }),
            pointHoverRadius: 5,
            pointBackgroundColor: 'rgb(75, 192, 192)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }];
        
        // Add absolute cheapest block highlighting (green) - only if not overlapping with future block
        if (absoluteCheapestBlockIndices.length > 0) {
            const absoluteData = chartData.prices.map((price, index) => {
                // Only highlight if not in future block (future takes priority)
                return absoluteCheapestBlockIndices.includes(index) && !futureCheapestBlockIndices.includes(index) 
                    ? price : null;
            });
            
            datasets.push({
                label: 'Absolute Cheapest Block',
                data: absoluteData,
                borderColor: 'rgb(25, 135, 84)',  // Green
                backgroundColor: 'rgba(25, 135, 84, 0.3)',
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: 'rgb(25, 135, 84)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.1,
                showLine: false
            });
        }
        
        // Add future cheapest block highlighting (blue) - takes priority
        if (futureCheapestBlockIndices.length > 0) {
            const futureData = chartData.prices.map((price, index) => {
                return futureCheapestBlockIndices.includes(index) ? price : null;
            });
            
            datasets.push({
                label: 'Cheapest Remaining Block',
                data: futureData,
                borderColor: 'rgb(13, 110, 253)',  // Blue
                backgroundColor: 'rgba(13, 110, 253, 0.3)',
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: 'rgb(13, 110, 253)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.1,
                showLine: false
            });
        }
        
        // Add lowest price highlighting (if no blocks and duration not specified)
        if (lowestPriceIndex !== null && !hasDuration && absoluteCheapestBlockIndices.length === 0 && futureCheapestBlockIndices.length === 0) {
            const lowestData = chartData.prices.map((price, index) => {
                return index === lowestPriceIndex ? price : null;
            });
            
            datasets.push({
                label: 'Lowest Price',
                data: lowestData,
                borderColor: 'rgb(25, 135, 84)',  // Green
                backgroundColor: 'rgba(25, 135, 84, 0.3)',
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: 'rgb(25, 135, 84)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                showLine: false
            });
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price (p/kWh)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' p/kWh';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
</script>
{% endblock %}

