{% extends "base.html" %}

{% set page_name = 'prices' %}

{% block content %}
<article>
    <header>
        <h1 class="mb-4">Agile Octopus Prices</h1>
    </header>
    
    <section class="mb-4">
        <!-- Product Info -->
        {% if product_code and product_name %}
        <div class="alert alert-info mb-3">
            <strong>Using tariff:</strong> {{ product_code }} ‚Äî {{ product_name }}
        </div>
        {% endif %}
    </section>
    
    <!-- Section 2: Cheapest Blocks -->
    <section class="mb-4">
        <h2 class="h5 mb-3">Cheapest Charging Options{% if region and regions %}{% for r in regions %}{% if r.region == region %} for {{ r.name }}{% endif %}{% endfor %}{% endif %}</h2>


        <!-- Daily Average Price(s) -->
        {% if daily_averages_by_date %}
        <div class="card border-secondary mb-4">
            <div class="card-body">
                {% if daily_averages_by_date|length == 1 %}
                    <!-- Single day: display one average (backward compatible) -->
                    <p class="mb-0">
                        <strong>Daily Average Price:</strong> 
                        <span class="h4 text-secondary">{{ "%.2f"|format(daily_averages_by_date[0].average_price) }} p/kWh</span>
                    </p>
                {% else %}
                    <!-- Multiple days: display one average per date -->
                    <p class="mb-2"><strong>Daily Average Prices:</strong></p>
                    <ul class="mb-0 list-unstyled">
                        {% for day_avg in daily_averages_by_date %}
                        <li>
                            <strong>{{ day_avg.date_display }}</strong> ‚Äì 
                            <span class="h5 text-secondary">{{ "%.2f"|format(day_avg.average_price) }} p/kWh</span>
                        </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if cheapest_per_day|length == 1 %}
            <!-- Single day: display as before (backward compatible) -->
            <div class="row">
                {% set day_data = cheapest_per_day[0] %}
                <!-- Lowest Price -->
                {% if day_data.lowest_price %}
                <div class="col-md-4 mb-4">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">üí∞ Lowest 30-Minute Price</h5>
                        </div>
                        <div class="card-body">
                            <h3 class="text-success">{{ "%.2f"|format(day_data.lowest_price.price) }} p/kWh</h3>
                            {% if daily_averages_map %}
                                {% set block_date_iso = day_data.lowest_price.time_from_uk.date().strftime('%Y-%m-%d') %}
                                {% if block_date_iso in daily_averages_map %}
                                    {% set daily_avg_price = daily_averages_map[block_date_iso] %}
                                    {% set block_price = day_data.lowest_price.price %}
                                    {% set savings_pct_raw = ((daily_avg_price - block_price) / daily_avg_price * 100) if daily_avg_price > 0 else 0 %}
                                    {% set savings_pct = savings_pct_raw if savings_pct_raw > 0 else 0 %}
                                    <p class="mb-1">
                                        <small class="{% if savings_pct > 0 %}text-success{% else %}text-muted{% endif %}">
                                            <strong>{{ "%.1f"|format(savings_pct) }}%</strong> cheaper than the daily average
                                        </small>
                                    </p>
                                {% endif %}
                            {% endif %}
                            <p class="mb-1">
                                <strong>Time:</strong> 
                                {{ day_data.lowest_price.time_from_uk.strftime('%d/%m %H:%M') }} - 
                                {{ day_data.lowest_price.time_to_uk.strftime('%H:%M') }}
                            </p>
                            {% set lowest_price_end_uk = day_data.lowest_price.time_to_uk %}
                            {% if lowest_price_end_uk < current_time_uk %}
                            <p class="mb-0"><small class="text-muted">‚è±Ô∏è Already passed</small></p>
                            {% else %}
                            <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Cheapest Block -->
                {% if day_data.cheapest_block %}
                <div class="col-md-4 mb-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">‚ö° Cheapest {{ duration }}h Block</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-1">
                                <strong>Average price:</strong> 
                                <span class="h4 text-warning">{{ "%.2f"|format(day_data.cheapest_block.average_price) }} p/kWh</span>
                            </p>
                            {% if daily_averages_map %}
                                {% set block_date_iso = day_data.cheapest_block.start_time_uk.date().strftime('%Y-%m-%d') %}
                                {% if block_date_iso in daily_averages_map %}
                                    {% set daily_avg_price = daily_averages_map[block_date_iso] %}
                                    {% set block_price = day_data.cheapest_block.average_price %}
                                    {% set savings_pct_raw = ((daily_avg_price - block_price) / daily_avg_price * 100) if daily_avg_price > 0 else 0 %}
                                    {% set savings_pct = savings_pct_raw if savings_pct_raw > 0 else 0 %}
                                    <p class="mb-1">
                                        <small class="{% if savings_pct > 0 %}text-success{% else %}text-muted{% endif %}">
                                            <strong>{{ "%.1f"|format(savings_pct) }}%</strong> cheaper than the daily average
                                        </small>
                                    </p>
                                {% endif %}
                            {% endif %}
                            <p class="mb-1">
                                <strong>Time:</strong> 
                                {{ day_data.cheapest_block.start_time_uk.strftime('%d/%m %H:%M') }} - 
                                {{ day_data.cheapest_block.end_time_uk.strftime('%H:%M') }}
                            </p>
                            {% set abs_block_end_uk = day_data.cheapest_block.end_time_uk %}
                            {% if abs_block_end_uk < current_time_uk %}
                            <p class="mb-0"><small class="text-muted">‚è±Ô∏è Already passed</small></p>
                            {% else %}
                            <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Future Cheapest Block -->
                {% if day_data.cheapest_remaining_block %}
                <div class="col-md-4 mb-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">üîÆ Cheapest Remaining {{ duration }}h Block</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-1">
                                <strong>Average price:</strong> 
                                <span class="h4 text-info">{{ "%.2f"|format(day_data.cheapest_remaining_block.average_price) }} p/kWh</span>
                            </p>
                            {% if daily_averages_map %}
                                {% set block_date_iso = day_data.cheapest_remaining_block.start_time_uk.date().strftime('%Y-%m-%d') %}
                                {% if block_date_iso in daily_averages_map %}
                                    {% set daily_avg_price = daily_averages_map[block_date_iso] %}
                                    {% set block_price = day_data.cheapest_remaining_block.average_price %}
                                    {% set savings_pct_raw = ((daily_avg_price - block_price) / daily_avg_price * 100) if daily_avg_price > 0 else 0 %}
                                    {% set savings_pct = savings_pct_raw if savings_pct_raw > 0 else 0 %}
                                    <p class="mb-1">
                                        <small class="{% if savings_pct > 0 %}text-success{% else %}text-muted{% endif %}">
                                            <strong>{{ "%.1f"|format(savings_pct) }}%</strong> cheaper than the daily average
                                        </small>
                                    </p>
                                {% endif %}
                            {% endif %}
                            <p class="mb-1">
                                <strong>Time:</strong> 
                                {{ day_data.cheapest_remaining_block.start_time_uk.strftime('%d/%m %H:%M') }} - 
                                {{ day_data.cheapest_remaining_block.end_time_uk.strftime('%H:%M') }}
                            </p>
                            {% if estimated_cost %}
                            <p class="mb-1">
                                <strong>Estimated Cost:</strong> 
                                <span class="h5 text-info">¬£{{ "%.2f"|format(estimated_cost) }}</span>
                            </p>
                            {% endif %}
                            <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
            <!-- Multiple days: display per-day results grouped under date headers -->
            {% for day_data in cheapest_per_day %}
                <!-- Date Header -->
                <div class="row mb-3 mt-4">
                    <div class="col-12">
                        <h3 class="mb-0">{{ day_data.date_display }}</h3>
                        <hr class="mt-2 mb-3">
                    </div>
                </div>
                
                <!-- Cards for this date -->
                <div class="row">
                        <!-- Lowest Price for Day {{ day_data.date_display }} -->
                        {% if day_data.lowest_price %}
                        <div class="col-md-4 mb-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">üí∞ Lowest 30-Minute Price</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-success">{{ "%.2f"|format(day_data.lowest_price.price) }} p/kWh</h3>
                                    {% if daily_averages_map %}
                                        {% set block_date_iso = day_data.lowest_price.time_from_uk.date().strftime('%Y-%m-%d') %}
                                        {% if block_date_iso in daily_averages_map %}
                                            {% set daily_avg_price = daily_averages_map[block_date_iso] %}
                                            {% set block_price = day_data.lowest_price.price %}
                                            {% set savings_pct_raw = ((daily_avg_price - block_price) / daily_avg_price * 100) if daily_avg_price > 0 else 0 %}
                                            {% set savings_pct = savings_pct_raw if savings_pct_raw > 0 else 0 %}
                                            <p class="mb-1">
                                                <small class="{% if savings_pct > 0 %}text-success{% else %}text-muted{% endif %}">
                                                    <strong>{{ "%.1f"|format(savings_pct) }}%</strong> cheaper than the daily average
                                                </small>
                                            </p>
                                        {% endif %}
                                    {% endif %}
                                    <p class="mb-1">
                                        <strong>Time:</strong> 
                                        {{ day_data.lowest_price.time_from_uk.strftime('%d/%m %H:%M') }} - 
                                        {{ day_data.lowest_price.time_to_uk.strftime('%H:%M') }}
                                    </p>
                                    {% set lowest_price_end_uk = day_data.lowest_price.time_to_uk %}
                                    {% if lowest_price_end_uk < current_time_uk %}
                                    <p class="mb-0"><small class="text-muted">‚è±Ô∏è Already passed</small></p>
                                    {% else %}
                                    <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Cheapest Block for Day {{ day_data.date_display }} -->
                        {% if day_data.cheapest_block %}
                        <div class="col-md-4 mb-4">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">‚ö° Cheapest {{ duration }}h Block</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1">
                                        <strong>Average price:</strong> 
                                        <span class="h4 text-warning">{{ "%.2f"|format(day_data.cheapest_block.average_price) }} p/kWh</span>
                                    </p>
                                    {% if daily_averages_map %}
                                        {% set block_date_iso = day_data.cheapest_block.start_time_uk.date().strftime('%Y-%m-%d') %}
                                        {% if block_date_iso in daily_averages_map %}
                                            {% set daily_avg_price = daily_averages_map[block_date_iso] %}
                                            {% set block_price = day_data.cheapest_block.average_price %}
                                            {% set savings_pct_raw = ((daily_avg_price - block_price) / daily_avg_price * 100) if daily_avg_price > 0 else 0 %}
                                            {% set savings_pct = savings_pct_raw if savings_pct_raw > 0 else 0 %}
                                            <p class="mb-1">
                                                <small class="{% if savings_pct > 0 %}text-success{% else %}text-muted{% endif %}">
                                                    <strong>{{ "%.1f"|format(savings_pct) }}%</strong> cheaper than the daily average
                                                </small>
                                            </p>
                                        {% endif %}
                                    {% endif %}
                                    <p class="mb-1">
                                        <strong>Time:</strong> 
                                        {{ day_data.cheapest_block.start_time_uk.strftime('%d/%m %H:%M') }} - 
                                        {{ day_data.cheapest_block.end_time_uk.strftime('%H:%M') }}
                                    </p>
                                    {% set abs_block_end_uk = day_data.cheapest_block.end_time_uk %}
                                    {% if abs_block_end_uk < current_time_uk %}
                                    <p class="mb-0"><small class="text-muted">‚è±Ô∏è Already passed</small></p>
                                    {% else %}
                                    <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Cheapest Remaining Block for Day {{ day_data.date_display }} -->
                        {% if day_data.cheapest_remaining_block %}
                        <div class="col-md-4 mb-4">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">üîÆ Cheapest Remaining {{ duration }}h Block</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1">
                                        <strong>Average price:</strong> 
                                        <span class="h4 text-info">{{ "%.2f"|format(day_data.cheapest_remaining_block.average_price) }} p/kWh</span>
                                    </p>
                                    {% if daily_averages_map %}
                                        {% set block_date_iso = day_data.cheapest_remaining_block.start_time_uk.date().strftime('%Y-%m-%d') %}
                                        {% if block_date_iso in daily_averages_map %}
                                            {% set daily_avg_price = daily_averages_map[block_date_iso] %}
                                            {% set block_price = day_data.cheapest_remaining_block.average_price %}
                                            {% set savings_pct_raw = ((daily_avg_price - block_price) / daily_avg_price * 100) if daily_avg_price > 0 else 0 %}
                                            {% set savings_pct = savings_pct_raw if savings_pct_raw > 0 else 0 %}
                                            <p class="mb-1">
                                                <small class="{% if savings_pct > 0 %}text-success{% else %}text-muted{% endif %}">
                                                    <strong>{{ "%.1f"|format(savings_pct) }}%</strong> cheaper than the daily average
                                                </small>
                                            </p>
                                        {% endif %}
                                    {% endif %}
                                    <p class="mb-1">
                                        <strong>Time:</strong> 
                                        {{ day_data.cheapest_remaining_block.start_time_uk.strftime('%d/%m %H:%M') }} - 
                                        {{ day_data.cheapest_remaining_block.end_time_uk.strftime('%H:%M') }}
                                    </p>
                                    <p class="mb-0"><small class="text-muted">‚è±Ô∏è Upcoming</small></p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                </div>
            {% endfor %}
        {% endif %}
        
        {% if cheapest_per_day|length == 1 and not cheapest_per_day[0].cheapest_remaining_block and duration and duration > 0 %}
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">üîÆ Cheapest Remaining Block</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-0 text-muted">No remaining cheap blocks today</p>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </section>
    
    <!-- Section 1: User Inputs -->
    <section class="mb-4">
        
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="h5 mb-3">Change Block Duration, Usage / Battery Capacity and Region Options</h2>
                <form method="GET" action="{{ url_for('main.prices') }}" class="row g-3">

                    <div class="col-md-3">
                        <label for="duration" class="form-label">Block Duration (hours)</label>
                        <input type="number" 
                               class="form-control" 
                               id="duration" 
                               name="duration" 
                               value="{{ duration }}" 
                               step="0.5" 
                               min="0.5" 
                               max="6.0" 
                               required
                               inputmode="decimal"
                               aria-describedby="duration-help">
                        <small id="duration-help" class="text-muted form-text">Supports decimals (e.g., 3.5)</small>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="capacity" class="form-label">Usage / Battery Capacity (kWh)</label>
                        <input type="number" 
                               class="form-control" 
                               id="capacity" 
                               name="capacity" 
                               value="{{ capacity if capacity else '' }}" 
                               step="0.1" 
                               min="0.1" 
                               placeholder="e.g., 10.0"
                               inputmode="decimal"
                               aria-describedby="capacity-help">
                        <small id="capacity-help" class="text-muted form-text">Enter your battery capacity in kilowatt-hours</small>
                    </div>

                    {% if agile_products and agile_products|length > 1 %}
                    <div class="col-md-3">
                        <label for="product" class="form-label">Agile Tariff Version</label>
                        <select class="form-select" id="product" name="product" required aria-describedby="product-help">
                            {% for p in agile_products %}
                            <option value="{{ p.code }}" {% if p.code == product_code %}selected{% endif %}>
                                {{ p.code }} ‚Äî {{ p.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small id="product-help" class="form-text text-muted sr-only">Select the Agile tariff version</small>
                    </div>
                    {% else %}
                    <input type="hidden" name="product" value="{{ product_code }}">
                    {% endif %}
                    
                    <div class="col-md-3">
                        <label for="region" class="form-label">Change  Region</label>
                        <select class="form-select" id="region" name="region" required aria-describedby="region-help">
                            {% for r in regions %}
                            <option value="{{ r.region }}" {% if r.region == region %}selected{% endif %}>
                                {{ r.region }} - {{ r.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small id="region-help" class="form-text text-muted sr-only">Select your energy pricing region</small>
                    </div>
                    
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Update</button>
                    </div>
                </form>
            </div>
        </div>
        
    </section>

    {% include 'components/_feature_voting.html' %}

    <!-- Section 3: Price Chart -->
    <section class="mb-4">
        <h2 class="h5 mb-3">Price Chart</h2>
        {% if chart_data %}
        <div class="card mb-4">
            <div class="card-body">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="priceChart" aria-label="Price chart showing half-hourly electricity prices throughout the day" role="img"></canvas>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p class="mb-0">Price chart will appear here once you select a region and update the prices.</p>
        </div>
        {% endif %}
    </section>
    

    <!-- Section 4: Price Table -->
    <section class="mb-4">
        <h2 class="h5 mb-3">All Prices (Half-Hourly)</h2>
        {% if prices %}
        <div class="card mb-4">
            <div class="card-header">
                <p class="text-muted small mb-0">Complete list of prices with highlighted cheapest options.</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover" role="table" aria-label="Half-hourly electricity prices">
                        <thead>
                            <tr>
                                <th scope="col">Date & Time</th>
                                <th scope="col">Price (p/kWh)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for price in prices %}
                            {% set price_date_iso = price.date_iso %}
                            {% set is_lowest = price_date_iso in lowest_price_times_by_date and price.valid_from == lowest_price_times_by_date[price_date_iso] %}
                            {% set is_in_absolute_block = price_date_iso in absolute_cheapest_block_times_by_date and price.valid_from in absolute_cheapest_block_times_by_date[price_date_iso] %}
                            {% set is_in_future_block = price_date_iso in future_cheapest_block_times_by_date and price.valid_from in future_cheapest_block_times_by_date[price_date_iso] %}
                            {% if loop.first %}
                                {% set show_date = True %}
                            {% else %}
                                {% set prev_price = prices[loop.index0 - 1] %}
                                {% set prev_date = prev_price.date_iso %}
                                {% set show_date = price.date_iso != prev_date %}
                            {% endif %}
                            <tr {% if is_in_future_block %}class="table-info"{% elif is_in_absolute_block %}class="table-warning"{% elif is_lowest %}class="table-success"{% endif %}>
                                <td>
                                    {% if show_date %}
                                        <strong>{{ price.date_uk }}</strong><br>
                                    {% endif %}
                                    {{ price.time_uk }}
                                </td>
                                <td>
                                    <span class="visually-hidden">Price: </span>{{ "%.2f"|format(price.value_inc_vat) }}
                                    {% if is_lowest %}<span class="badge bg-success ms-2" aria-label="Lowest price">Lowest</span>{% endif %}
                                    {% if is_in_absolute_block %}<span class="badge bg-warning text-dark ms-2" aria-label="Part of cheapest block">Cheapest</span>{% endif %}
                                    {% if is_in_future_block and not is_in_absolute_block %}<span class="badge bg-info ms-2" aria-label="Part of cheapest remaining block">Cheapest Remaining</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p class="mb-0">Price table will appear here once you select a region and update the prices.</p>
        </div>
        {% endif %}
    </section>

    {% include 'components/_stats_2025_regional.html' %}
    
    {% include 'components/_feature_suggestion.html' %}
    
</article>
{% endblock %}

{% block scripts %}
<script>
    // Render price chart with highlighting
    {% if chart_data %}
    const chartData = {{ chart_data | tojson }};
    const absoluteCheapestBlockIndices = chartData.absolute_cheapest_block_indices || [];
    const futureCheapestBlockIndices = chartData.future_cheapest_block_indices || [];
    const lowestPriceIndex = chartData.lowest_price_index;
    
    // Per-day highlighting data (for multi-day support)
    const absoluteCheapestBlockTimesByDate = {{ absolute_cheapest_block_times_by_date | tojson }};
    const futureCheapestBlockTimesByDate = {{ future_cheapest_block_times_by_date | tojson }};
    const lowestPriceTimesByDate = {{ lowest_price_times_by_date | tojson }};
    const pricesWithDates = {{ prices | tojson }};
    
    // Build per-day indices for chart highlighting
    const absoluteCheapestBlockIndicesByDate = {};
    const futureCheapestBlockIndicesByDate = {};
    const lowestPriceIndicesByDate = {};
    
    if (pricesWithDates && pricesWithDates.length > 0) {
        pricesWithDates.forEach((price, index) => {
            const dateIso = price.date_iso;
            if (!dateIso) return;
            
            // Cheapest block indices
            if (absoluteCheapestBlockTimesByDate[dateIso] && absoluteCheapestBlockTimesByDate[dateIso].includes(price.valid_from)) {
                if (!absoluteCheapestBlockIndicesByDate[dateIso]) {
                    absoluteCheapestBlockIndicesByDate[dateIso] = [];
                }
                absoluteCheapestBlockIndicesByDate[dateIso].push(index);
            }
            
            // Cheapest remaining block indices
            if (futureCheapestBlockTimesByDate[dateIso] && futureCheapestBlockTimesByDate[dateIso].includes(price.valid_from)) {
                if (!futureCheapestBlockIndicesByDate[dateIso]) {
                    futureCheapestBlockIndicesByDate[dateIso] = [];
                }
                futureCheapestBlockIndicesByDate[dateIso].push(index);
            }
            
            // Lowest price index
            if (lowestPriceTimesByDate[dateIso] && price.valid_from === lowestPriceTimesByDate[dateIso]) {
                lowestPriceIndicesByDate[dateIso] = index;
            }
        });
    }
    
    // Use per-day data if available (multi-day), otherwise fall back to single-day
    const usePerDayHighlighting = Object.keys(absoluteCheapestBlockIndicesByDate).length > 0 || 
                                   Object.keys(futureCheapestBlockIndicesByDate).length > 0;
    
    const hasDuration = {{ duration|default(0)|float }} > 0;
    
    const ctx = document.getElementById('priceChart');
    if (ctx && chartData.labels && chartData.prices) {
        // Build combined indices from per-day data if multi-day, otherwise use single-day indices
        let combinedAbsoluteIndices = [];
        let combinedFutureIndices = [];
        let combinedLowestIndices = [];
        
        if (usePerDayHighlighting) {
            // Multi-day: combine all per-day indices
            Object.values(absoluteCheapestBlockIndicesByDate).forEach(indices => {
                combinedAbsoluteIndices.push(...indices);
            });
            Object.values(futureCheapestBlockIndicesByDate).forEach(indices => {
                combinedFutureIndices.push(...indices);
            });
            Object.values(lowestPriceIndicesByDate).forEach(index => {
                combinedLowestIndices.push(index);
            });
        } else {
            // Single-day: use backward-compatible indices
            combinedAbsoluteIndices = absoluteCheapestBlockIndices;
            combinedFutureIndices = futureCheapestBlockIndices;
            if (lowestPriceIndex !== null && lowestPriceIndex !== undefined) {
                combinedLowestIndices = [lowestPriceIndex];
            }
        }
        
        // Create a set of all indices that need highlighting (future block takes priority)
        const allHighlightedIndices = new Set([
            ...combinedAbsoluteIndices,
            ...combinedFutureIndices,
            ...combinedLowestIndices
        ]);
        
        // Create datasets - main line and highlighted points
        const datasets = [{
            label: 'Price (p/kWh)',
            data: chartData.prices,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            pointRadius: chartData.prices.map((price, index) => {
                return allHighlightedIndices.has(index) ? 0 : 3;
            }),
            pointHoverRadius: 5,
            pointBackgroundColor: 'rgb(75, 192, 192)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        }];
        
        // Add cheapest block highlighting (yellow/warning) - exclude future block and lowest price
        if (combinedAbsoluteIndices.length > 0) {
            const absoluteData = chartData.prices.map((price, index) => {
                // Only highlight if in cheapest block AND not in future block AND not lowest price
                return combinedAbsoluteIndices.includes(index) && 
                       !combinedFutureIndices.includes(index) && 
                       !combinedLowestIndices.includes(index)
                    ? price : null;
            });
            
            datasets.push({
                label: 'Cheapest Block',
                data: absoluteData,
                borderColor: 'rgb(255, 193, 7)',  // Bootstrap warning (yellow/amber) - matches table-warning and border-warning
                backgroundColor: 'rgba(255, 193, 7, 0.3)',
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: 'rgb(255, 193, 7)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.1,
                showLine: false,
                pointStyle: 'circle'  // Ensure bullet/point style in legend
            });
        }
        
        // Add future cheapest block highlighting (blue/info) - exclude lowest price
        if (combinedFutureIndices.length > 0) {
            const futureData = chartData.prices.map((price, index) => {
                // Only highlight if in future block AND not lowest price
                return combinedFutureIndices.includes(index) && !combinedLowestIndices.includes(index)
                    ? price : null;
            });
            
            datasets.push({
                label: 'Cheapest Remaining Block',
                data: futureData,
                borderColor: 'rgb(13, 202, 240)',  // Bootstrap info (cyan/blue) - matches table-info and border-info
                backgroundColor: 'rgba(13, 202, 240, 0.3)',
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: 'rgb(13, 202, 240)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                tension: 0.1,
                showLine: false,
                pointStyle: 'circle'  // Ensure bullet/point style in legend
            });
        }
        
        // Add lowest price highlighting (green) - takes highest priority
        if (combinedLowestIndices.length > 0) {
            const lowestData = chartData.prices.map((price, index) => {
                return combinedLowestIndices.includes(index) ? price : null;
            });
            
            datasets.push({
                label: 'Lowest 30-Minute Price',
                data: lowestData,
                borderColor: 'rgb(25, 135, 84)',  // Bootstrap success (green) - matches table-success and border-success
                backgroundColor: 'rgba(25, 135, 84, 0.3)',
                pointRadius: 10,
                pointHoverRadius: 12,
                pointBackgroundColor: 'rgb(25, 135, 84)',
                pointBorderColor: '#fff',
                pointBorderWidth: 3,
                tension: 0.1,
                showLine: false,
                pointStyle: 'circle'
            });
        }
        
        // Legacy: Add lowest price highlighting (if no blocks and duration not specified)
        if (lowestPriceIndex !== null && !hasDuration && absoluteCheapestBlockIndices.length === 0 && futureCheapestBlockIndices.length === 0) {
            const lowestData = chartData.prices.map((price, index) => {
                return index === lowestPriceIndex ? price : null;
            });
            
            datasets.push({
                label: 'Lowest Price',
                data: lowestData,
                borderColor: 'rgb(25, 135, 84)',  // Green
                backgroundColor: 'rgba(25, 135, 84, 0.3)',
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: 'rgb(25, 135, 84)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                showLine: false
            });
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price (p/kWh)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,  // Use point/bullet style instead of boxes (matches header badge style)
                            padding: 10,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' p/kWh';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
</script>
{% endblock %}

