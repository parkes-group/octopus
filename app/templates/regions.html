{% extends "base.html" %}

{% set page_name = 'regions' %}

{% block head %}
<!-- Page-specific Structured Data (JSON-LD) -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@graph": [
        {
            "@type": "WebPage",
            "@id": "{{ site_url }}/regions#webpage",
            "url": "{{ site_url }}/regions{% if product_code %}?product={{ product_code }}{% endif %}",
            "name": "Agile Octopus Regional Price Comparison",
            "description": "Compare Agile Octopus electricity prices across all 14 UK regions. See regional variations in cheapest time blocks, cheapest 30-minute slots, and cheapest remaining blocks.",
            "inLanguage": "en-GB",
            "isPartOf": {
                "@type": "WebSite",
                "name": "{{ site_name }}",
                "url": "{{ site_url }}"
            }
        },
        {
            "@type": "Report",
            "@id": "{{ site_url }}/regions#report",
            "name": "Agile Octopus Regional Price Comparison{% if product_code %} - {{ product_code }}{% endif %}",
            "description": "Comparative analysis of Agile Octopus electricity pricing across all 14 UK electricity regions. Shows cheapest 30-minute slot, cheapest continuous block ({{ duration_hours }} hours), and cheapest remaining block for each region.",
            "about": {
                "@type": "Thing",
                "name": "Octopus Agile Tariff Regional Pricing"
            },
            "datePublished": "{% if min_date_time_uk %}{{ min_date_time_uk.strftime('%Y-%m-%d') }}{% else %}{{ 'now'|date('%Y-%m-%d') }}{% endif %}",
            "temporalCoverage": "{% if min_date_time_uk and max_date_time_uk %}{{ min_date_time_uk.strftime('%Y-%m-%d') }}/{{ max_date_time_uk.strftime('%Y-%m-%d') }}{% endif %}",
            "spatialCoverage": {
                "@type": "Place",
                "name": "United Kingdom",
                "containedIn": {
                    "@type": "Country",
                    "name": "United Kingdom"
                }
            }
        },
        {
            "@type": "ItemList",
            "itemListElement": [
                {% for summary in region_summaries %}
                {
                    "@type": "ListItem",
                    "position": {{ loop.index }},
                    "item": {
                        "@type": "Place",
                        "name": "{{ summary.region_code }} - {{ summary.region_name }}",
                        "description": "Agile Octopus pricing region {{ summary.region_code }} ({{ summary.region_name }}){% if summary.cheapest_slot_price %} - Cheapest 30-min: {{ "%.2f"|format(summary.cheapest_slot_price) }}p/kWh{% endif %}{% if summary.cheapest_block_average %}, Cheapest {{ duration_hours }}h block: {{ "%.2f"|format(summary.cheapest_block_average) }}p/kWh{% endif %}"
                    }
                }{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        },
        {
            "@type": "FAQPage",
            "mainEntity": [
                {
                    "@type": "Question",
                    "name": "Why do Agile Octopus prices vary by region?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "UK electricity pricing varies by region due to local grid supply points (GSPs) and regional demand patterns. Each of the 14 UK regions has slightly different wholesale prices, which affects Agile Octopus unit rates. This comparison shows how the cheapest time blocks differ across regions."
                    }
                },
                {
                    "@type": "Question",
                    "name": "How should I use this regional comparison?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Use this comparison to understand regional price patterns. If you're moving or considering a different area, you can see which regions typically have lower prices. However, the most important factor is finding the cheapest times within your own region to reduce costs."
                    }
                },
                {
                    "@type": "Question",
                    "name": "Do regions affect how much I can save?",
                    "acceptedAnswer": {
                        "@type": "Answer",
                        "text": "Yes, regional variations in base prices affect potential savings. However, the percentage savings from using cheapest blocks (compared to daily average) tend to be similar across regions. The key to maximising savings is consistently using energy during your region's cheapest time blocks."
                    }
                }
            ]
        }
    ]
}
</script>
{% endblock %}

{% block content %}
<article>
    <header>
        <h1 class="mb-4">Region Price Summary</h1>
        <p class="lead">Compare Agile Octopus prices across all UK regions</p>
    </header>
    
    <section>
        <!-- Product Info -->
        {% if product_code and product_name %}
        <div class="alert alert-info mb-3">
            <strong>Using tariff:</strong> {{ product_code }} — {{ product_name }}
        </div>
        {% endif %}
        
        <!-- Product Selection -->
        {% if agile_products and agile_products|length > 1 %}
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('main.regions') }}" class="row g-3">
                    <div class="col-md-6">
                        <label for="product" class="form-label">Agile Tariff Version</label>
                        <select class="form-select" id="product" name="product" required aria-describedby="product-help" onchange="this.form.submit()">
                            {% for p in agile_products %}
                            <option value="{{ p.code }}" {% if p.code == product_code %}selected{% endif %}>
                                {{ p.code }} — {{ p.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                        <small id="product-help" class="form-text text-muted">Select the Agile tariff version to compare</small>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
        
        <!-- Summary Info -->
        <div class="alert alert-secondary mb-4">
            <p class="mb-0">
                <strong>Block Duration:</strong> {{ duration_hours }} hours | 
                <strong>Regions:</strong> {{ region_summaries|length }} | 
                <strong>Data:</strong> 
                {% if min_date_time_uk and max_date_time_uk %}
                    {{ min_date_time_uk.strftime('%d/%m %H:%M') }} - {{ max_date_time_uk.strftime('%d/%m %H:%M') }}
                {% else %}
                    Today's prices
                {% endif %}
            </p>
            <p class="mb-0 mt-2 small">
                <strong>Tip:</strong> Click a region name to view that region’s full prices page with charts and cheapest blocks.
            </p>
        </div>
        
        <!-- Mobile: Card View -->
        <div class="d-md-none">
            {% for summary in region_summaries %}
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        {% if summary.region_slug %}
                            {% if default_product_code and product_code == default_product_code %}
                                <a class="text-white text-decoration-underline" href="{{ url_for('main.prices_region', region_slug=summary.region_slug) }}">
                            {% else %}
                                <a class="text-white text-decoration-underline" href="{{ url_for('main.prices_region', region_slug=summary.region_slug, product=product_code) }}">
                            {% endif %}
                                {{ summary.region_code }} - {{ summary.region_name }}
                            </a>
                        {% else %}
                            {{ summary.region_code }} - {{ summary.region_name }}
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if summary.error %}
                    <div class="alert alert-danger mb-0">
                        <small>Error: {{ summary.error }}</small>
                    </div>
                    {% else %}
                    <div class="row g-2">
                        <div class="col-12">
                            <p class="mb-1">
                                <strong>Cheapest 30-Min Slot:</strong> 
                                <span class="h6">
                                    {{ "%.2f"|format(summary.cheapest_slot_price) if summary.cheapest_slot_price else "N/A" }} p/kWh
                                </span>
                                {% if summary.cheapest_slot_time_from_uk %}
                                <br><small class="text-muted">{{ summary.cheapest_slot_time_from_uk.strftime('%d/%m %H:%M') }}</small>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-12">
                            <p class="mb-1">
                                <strong>Cheapest {{ duration_hours }}h Block:</strong> 
                                <span class="h6">
                                    {{ "%.2f"|format(summary.cheapest_block_average) if summary.cheapest_block_average else "N/A" }} p/kWh
                                </span>
                                {% if summary.cheapest_block_start_uk and summary.cheapest_block_end_uk %}
                                {% set block_start_date = summary.cheapest_block_start_uk.date() %}
                                {% set block_end_date = summary.cheapest_block_end_uk.date() %}
                                <br><small class="text-muted">
                                    {{ summary.cheapest_block_start_uk.strftime('%d/%m %H:%M') }} - 
                                    {% if block_start_date != block_end_date %}
                                        {{ summary.cheapest_block_end_uk.strftime('%d/%m %H:%M') }}
                                    {% else %}
                                        {{ summary.cheapest_block_end_uk.strftime('%H:%M') }}
                                    {% endif %}
                                </small>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-12">
                            <p class="mb-0">
                                <strong>Cheapest Remaining Block:</strong> 
                                <span class="h6">
                                    {{ "%.2f"|format(summary.future_block_average) if summary.future_block_average else "N/A" }} p/kWh
                                </span>
                                {% if summary.future_block_start_uk and summary.future_block_end_uk %}
                                {% set future_start_date = summary.future_block_start_uk.date() %}
                                {% set future_end_date = summary.future_block_end_uk.date() %}
                                <br><small class="text-muted">
                                    {{ summary.future_block_start_uk.strftime('%d/%m %H:%M') }} - 
                                    {% if future_start_date != future_end_date %}
                                        {{ summary.future_block_end_uk.strftime('%d/%m %H:%M') }}
                                    {% else %}
                                        {{ summary.future_block_end_uk.strftime('%H:%M') }}
                                    {% endif %}
                                </small>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Desktop: Table View -->
        <div class="d-none d-md-block">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">All Regions Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" role="table" aria-label="Region price comparison">
                            <thead>
                                <tr>
                                    <th scope="col">Region</th>
                                    <th scope="col">Cheapest 30-Min Slot</th>
                                    <th scope="col">Cheapest {{ duration_hours }}h Block</th>
                                    <th scope="col">Cheapest Remaining Block</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for summary in region_summaries %}
                                <tr>
                                    <td>
                                        <strong>{{ summary.region_code }}</strong><br>
                                        {% if summary.region_slug %}
                                            {% if default_product_code and product_code == default_product_code %}
                                                <a class="small text-decoration-underline" href="{{ url_for('main.prices_region', region_slug=summary.region_slug) }}">
                                            {% else %}
                                                <a class="small text-decoration-underline" href="{{ url_for('main.prices_region', region_slug=summary.region_slug, product=product_code) }}">
                                            {% endif %}
                                                {{ summary.region_name }}
                                            </a>
                                        {% else %}
                                            <small class="text-muted">{{ summary.region_name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if summary.error %}
                                        <span class="text-danger">Error</span>
                                        {% else %}
                                        {{ "%.2f"|format(summary.cheapest_slot_price) if summary.cheapest_slot_price else "N/A" }} p/kWh
                                        {% if summary.cheapest_slot_time_from_uk %}
                                        <br><small class="text-muted">{{ summary.cheapest_slot_time_from_uk.strftime('%d/%m %H:%M') }}</small>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if summary.error %}
                                        <span class="text-danger">Error</span>
                                        {% else %}
                                        {{ "%.2f"|format(summary.cheapest_block_average) if summary.cheapest_block_average else "N/A" }} p/kWh
                                        {% if summary.cheapest_block_start_uk and summary.cheapest_block_end_uk %}
                                        {% set block_start_date = summary.cheapest_block_start_uk.date() %}
                                        {% set block_end_date = summary.cheapest_block_end_uk.date() %}
                                        <br><small class="text-muted">
                                            {{ summary.cheapest_block_start_uk.strftime('%d/%m %H:%M') }} - 
                                            {% if block_start_date != block_end_date %}
                                                {{ summary.cheapest_block_end_uk.strftime('%d/%m %H:%M') }}
                                            {% else %}
                                                {{ summary.cheapest_block_end_uk.strftime('%H:%M') }}
                                            {% endif %}
                                        </small>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if summary.error %}
                                        <span class="text-danger">Error</span>
                                        {% else %}
                                        {{ "%.2f"|format(summary.future_block_average) if summary.future_block_average else "N/A" }} p/kWh
                                        {% if summary.future_block_start_uk and summary.future_block_end_uk %}
                                        {% set future_start_date = summary.future_block_start_uk.date() %}
                                        {% set future_end_date = summary.future_block_end_uk.date() %}
                                        <br><small class="text-muted">
                                            {{ summary.future_block_start_uk.strftime('%d/%m %H:%M') }} - 
                                            {% if future_start_date != future_end_date %}
                                                {{ summary.future_block_end_uk.strftime('%d/%m %H:%M') }}
                                            {% else %}
                                                {{ summary.future_block_end_uk.strftime('%H:%M') }}
                                            {% endif %}
                                        </small>
                                        {% endif %}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Legend/Explanation -->
        <div class="alert alert-light mt-4">
            <h6 class="mb-2">How to read this summary:</h6>
            <ul class="mb-0 small">
                <li><strong>Cheapest 30-Min Slot:</strong> The single lowest price slot and its time</li>
                <li><strong>Cheapest {{ duration_hours }}h Block:</strong> The cheapest contiguous {{ duration_hours }}-hour period across all prices today, showing average price and time range</li>
                <li><strong>Cheapest Remaining Block:</strong> The cheapest contiguous {{ duration_hours }}-hour period considering only future time slots (from now onwards), showing average price and time range</li>
            </ul>
        </div>
    </section>
    
    <section class="mb-4">
        {% include 'components/_feature_voting.html' %}
    </section>
    
    <section class="mb-4">
        {% include 'components/_feature_suggestion.html' %}
    </section>

</article>
{% endblock %}

